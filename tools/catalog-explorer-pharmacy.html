<!DOCTYPE html>
<html>
<head>
    <title>Pharmacy Catalog Explorer</title>
    <style>
        /* Basic setup for full-height, flexible layout */
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
            box-sizing: border-box;
        }
        
        body.wait {
            cursor: wait !important;
        }

        /* Main container to manage padding and centering */
        .main-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 20px;
            min-height: 0;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .section {
            margin-bottom: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        /* Layout containers */
        .layout-container { display: flex; flex-direction: row; gap: 20px; }
        .layout-left { width: 50%; }
        .layout-right { width: 50%; display: flex; flex-direction: column; }
        
        .search-results-container { display: flex; gap: 20px; }
        .search-results-left { flex: 1; }
        .search-results-right { flex: 2; }


        .hidden { display: none !important; }
        
        .status-text { min-height: 20px; margin-top: 5px; font-style: italic; color: #28a745; }

        .disabled { opacity: 0.5; pointer-events: none; background-color: #6c757d; }

        button {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            margin-bottom: 10px;
        }
        
        button.clear-btn { background-color: #6c757d; }
        button:hover:not(.disabled) { background-color: #0b5ed7; }
        button.clear-btn:hover:not(.disabled) { background-color: #5c636a; }

        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; }
        
        #searchResultsContainer tr:hover { background-color: #f0f2f5; }
        #searchResultsContainer .clickable-row { cursor: pointer; }


        .table-container { max-height: 400px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 20px; }
        .preview-container:not(:empty) { margin-bottom: 20px; }
        
        #logConsole { width: 100%; flex-grow: 1; box-sizing: border-box; background-color: #2d3748; color: #f7fafc; border: 1px solid #ccc; border-radius: 5px; padding: 10px; font-family: monospace; font-size: 14px; }

        /* Search Page Specific Styles */
        #searchControls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        #searchControls.loading * { cursor: wait !important; }

        #searchColumnSelect, #searchInput { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        #searchInput { flex-grow: 1; }
        
        #itemDetailsContainer .detail-table th { width: 30%; background-color: #f8f9fa; }
        .double-click-note { font-style: italic; color: #6c757d; margin-top: 10px;}

        .paste-area {
            width: 100%;
            min-height: 100px;
            margin-top: 10px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px dashed #ccc;
        }
        
        #loadingIndicator {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #6c757d;
        }

    </style>
</head>
<body>
<div class="main-container">
    <h2>Pharmacy Catalog Explorer</h2>

    <!-- Two-column layout for loading phase -->
    <div id="loadingLayoutContainer" class="layout-container">
        <!-- Data Loading Section (Left Column) -->
        <div id="loadDataSection" class="section layout-left">
            <h2>Load Data</h2>
            <button id="copyCode1Btn">Copy CCL to Clipboard (Dataset 1)</button>
            <p id="code1Status" class="status-text"></p>
            <div id="pasteArea1Container" class="hidden">
                <textarea id="pasteArea1" class="paste-area" placeholder="Paste data for Dataset 1 here..."></textarea>
                <button id="processData1Btn">Process Pasted Data (Dataset 1)</button>
            </div>
            <p id="data1Status" class="status-text"></p>
            <div id="data1PreviewContainer" class="preview-container table-container"></div>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <button id="copyCode2Btn">Copy CCL to Clipboard (Dataset 2)</button>
            <p id="code2Status" class="status-text"></p>
            <div id="pasteArea2Container" class="hidden">
                <textarea id="pasteArea2" class="paste-area" placeholder="Paste data for Dataset 2 here..."></textarea>
                <button id="processData2Btn">Process Pasted Data (Dataset 2)</button>
            </div>
            <p id="data2Status" class="status-text"></p>
            <div id="data2PreviewContainer" class="preview-container table-container"></div>
        </div>

        <!-- Console Log Section (Right Column) -->
        <div class="section layout-right">
            <h3>Console Log</h3>
            <textarea id="logConsole" readonly></textarea>
        </div>
    </div>

    <!-- Search and Exploration Section (Initially hidden) -->
    <div id="searchSection" class="section hidden">
        <div id="searchControls">
            <select id="searchColumnSelect"></select>
            <input type="text" id="searchInput" placeholder="Type to search...">
            <button id="searchGoBtn">Go</button>
            <button id="clearSearchBtn" class="clear-btn">Clear</button>
        </div>
        <p id="searchScenarioNote" class="double-click-note"></p>
        <div id="searchResultsContainer" class="table-container">
            <div id="loadingIndicator" class="hidden"><p>Loading...</p></div>
        </div>
    </div>
</div>
    <script>
        // --- GLOBAL STATE ---
        let appState = {
            datasets: [],
            columnMetadata: []
        };

        // --- DOM ELEMENT REFERENCES ---
        const loadingLayoutContainer = document.getElementById('loadingLayoutContainer');
        const copyCode1Btn = document.getElementById('copyCode1Btn');
        const pasteArea1Container = document.getElementById('pasteArea1Container');
        const pasteArea1 = document.getElementById('pasteArea1');
        const processData1Btn = document.getElementById('processData1Btn');
        const data1PreviewContainer = document.getElementById('data1PreviewContainer');
        const code1Status = document.getElementById('code1Status');
        const data1Status = document.getElementById('data1Status');
        
        const copyCode2Btn = document.getElementById('copyCode2Btn');
        const pasteArea2Container = document.getElementById('pasteArea2Container');
        const pasteArea2 = document.getElementById('pasteArea2');
        const processData2Btn = document.getElementById('processData2Btn');
        const data2PreviewContainer = document.getElementById('data2PreviewContainer');
        const code2Status = document.getElementById('code2Status');
        const data2Status = document.getElementById('data2Status');

        const searchSection = document.getElementById('searchSection');
        const searchControls = document.getElementById('searchControls');
        const searchColumnSelect = document.getElementById('searchColumnSelect');
        const searchInput = document.getElementById('searchInput');
        const searchGoBtn = document.getElementById('searchGoBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const searchScenarioNote = document.getElementById('searchScenarioNote');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        const logConsole = document.getElementById('logConsole');

        // --- CORE FUNCTIONS ---

        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            logConsole.value += `[${timestamp}] ${message}\n`;
            logConsole.scrollTop = logConsole.scrollHeight;
        }
        
        function copyTextToClipboard(text) {
            return new Promise((resolve, reject) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; 
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) resolve();
                    else reject(new Error('Copy command was not successful'));
                } catch (err) {
                    reject(err);
                }
                document.body.removeChild(textArea);
            });
        }

        function copyCode(url) {
            return fetch(url)
                .then(response => response.text())
                .then(text => copyTextToClipboard(text));
        }

        function parseData(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split('\t').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split('\t');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }
        
        function renderDataTable(container, data, { rowCount, isClickable = false, onRowClick = null } = {}) {
            container.innerHTML = ''; // Clear previous content, including loading indicator
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No data to display.</p>';
                return;
            }
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headerRow = document.createElement('tr');
            const headers = Object.keys(data[0]);

            headers.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            const dataToRender = rowCount ? data.slice(0, rowCount) : data;
            
            dataToRender.forEach((item) => {
                const row = document.createElement('tr');
                if (isClickable) {
                    row.classList.add('clickable-row');
                    if(onRowClick) {
                       row.onclick = () => onRowClick(item);
                    }
                }
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = item[header];
                    row.appendChild(td);
                })
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
        }
        
        function setSearchLoadingState(isLoading) {
             if(isLoading) {
                document.body.classList.add('wait');
                searchControls.classList.add('loading');
                [searchInput, searchColumnSelect, searchGoBtn, clearSearchBtn].forEach(el => el.disabled = true);
                searchResultsContainer.innerHTML = '';
                loadingIndicator.classList.remove('hidden');
             } else {
                document.body.classList.remove('wait');
                searchControls.classList.remove('loading');
                [searchInput, searchColumnSelect, searchGoBtn, clearSearchBtn].forEach(el => el.disabled = false);
                loadingIndicator.classList.add('hidden');
             }
        }

        function resetApp() {
            appState.datasets = [];
            appState.columnMetadata = [];
            copyCode1Btn.classList.remove('disabled');
            copyCode2Btn.classList.add('disabled');
            [pasteArea1Container, pasteArea2Container, searchSection].forEach(el => el.classList.add('hidden'));
            [code1Status, data1Status, code2Status, data2Status, data1PreviewContainer, data2PreviewContainer].forEach(el => el.innerHTML = '');
            pasteArea1.value = '';
            pasteArea2.value = '';
            loadingLayoutContainer.classList.remove('hidden');
            logConsole.value = '';
            logMessage("Application reset. Ready to load data.");
            clearSearch();
        }

        function initializeSearchView() {
            logMessage("All datasets loaded. Initializing search view.");
            loadingLayoutContainer.classList.add('hidden');
            searchSection.classList.remove('hidden');

            searchColumnSelect.innerHTML = '';
            appState.columnMetadata = [];
            
            appState.datasets.forEach((dataset, index) => {
                if (dataset.length > 0) {
                    const headers = Object.keys(dataset[0]);
                    headers.forEach(header => {
                        const option = document.createElement('option');
                        const label = `${header} - (Dataset ${index + 1})`;
                        option.value = appState.columnMetadata.length;
                        option.textContent = label;
                        searchColumnSelect.appendChild(option);
                        appState.columnMetadata.push({ header, datasetIndex: index });
                    });
                }
            });

            const primaryOption = Array.from(searchColumnSelect.options).find(opt => opt.text === 'PRIMARY - (Dataset 1)');
            if (primaryOption) {
                searchColumnSelect.value = primaryOption.value;
            }
            handleSearch();
        }
        
        function handleSearch() {
            const metadataIndex = searchColumnSelect.value;
            if(!metadataIndex && metadataIndex !== 0) {
                searchResultsContainer.innerHTML = '';
                return;
            };

            setSearchLoadingState(true);
            logMessage(`Searching...`);

            // Use setTimeout to allow the UI to update with the loading state
            setTimeout(() => {
                const { header, datasetIndex } = appState.columnMetadata[metadataIndex];
                const query = searchInput.value.toLowerCase();
                const isScenario1 = datasetIndex === 0;
                
                const sourceData = appState.datasets[datasetIndex];
                const filteredData = sourceData.filter(row => row[header] && row[header].toLowerCase().includes(query));
                
                logMessage(`Found ${filteredData.length} results.`);

                if (isScenario1) {
                    searchScenarioNote.textContent = "Click a row to see details and linked data.";
                    renderDataTable(searchResultsContainer, filteredData, { 
                        isClickable: true,
                        onRowClick: (item) => {
                            const originalIndex = appState.datasets[0].indexOf(item);
                            showItemDetails(originalIndex);
                        }
                    });
                } else {
                    searchScenarioNote.textContent = "Double-click any cell to copy its value.";
                    renderDataTable(searchResultsContainer, filteredData);
                    searchResultsContainer.ondblclick = (e) => {
                        if (e.target && e.target.tagName === 'TD') {
                            copyTextToClipboard(e.target.textContent)
                                .then(() => logMessage(`Copied to clipboard: "${e.target.textContent}"`))
                                .catch(() => logMessage(`ERROR: Failed to copy text.`));
                        }
                    };
                }
                setSearchLoadingState(false);
            }, 10); // A small delay is enough to let the browser repaint
        }
        
        function showItemDetails(itemIndex) {
            const selectedItem = appState.datasets[0][itemIndex];
            searchResultsContainer.innerHTML = '';
            searchScenarioNote.textContent = '';
            searchResultsContainer.classList.remove('table-container');

            const wrapper = document.createElement('div');
            wrapper.className = 'search-results-container';

            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'search-results-left';
            detailsContainer.innerHTML = '<h3>Item Details (Dataset 1)</h3>';
            
            const detailTable = document.createElement('table');
            detailTable.className = 'detail-table';
            const tbody = document.createElement('tbody');
            for(const key in selectedItem) {
                tbody.innerHTML += `<tr><th>${key}</th><td>${selectedItem[key]}</td></tr>`;
            }
            detailTable.appendChild(tbody);
            detailsContainer.appendChild(detailTable);

            const linkedContainer = document.createElement('div');
            linkedContainer.className = 'search-results-right';
            linkedContainer.innerHTML = '<h3>Linked Data</h3>';
            
            const commonKeys = Object.keys(selectedItem).filter(key => 
                appState.datasets.slice(1).some(otherDataset => otherDataset.length > 0 && otherDataset[0].hasOwnProperty(key))
            );

            let linkedDataFound = false;
            if (commonKeys.length > 0) {
                 appState.datasets.forEach((otherDataset, index) => {
                    if (index === 0) return; 
                    
                    const relevantCommonKeys = commonKeys.filter(key => otherDataset.length > 0 && otherDataset[0].hasOwnProperty(key));
                    if (relevantCommonKeys.length > 0) {
                        const linkingKey = relevantCommonKeys[0]; 
                        const linkedData = otherDataset.filter(row => row[linkingKey] === selectedItem[linkingKey]);

                        if(linkedData.length > 0) {
                            linkedDataFound = true;
                            linkedContainer.innerHTML += `<h4>From Dataset ${index + 1} (linked by ${linkingKey})</h4>`;
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'table-container';
                            renderDataTable(tableContainer, linkedData);
                            linkedContainer.appendChild(tableContainer);
                        }
                    }
                });
            }

            if (!linkedDataFound) {
                linkedContainer.innerHTML += '<p>No linked data found in other datasets.</p>';
            }

            wrapper.appendChild(detailsContainer);
            wrapper.appendChild(linkedContainer);
            searchResultsContainer.appendChild(wrapper);
        }

        function clearSearch() {
            searchInput.value = '';
            searchResultsContainer.classList.add('table-container');
            searchScenarioNote.textContent = '';
            handleSearch();
        }

        // --- EVENT LISTENERS ---
        copyCode1Btn.addEventListener('click', () => {
            logMessage("Copying Dataset 1 CCL code...");
            copyCode("https://raw.githubusercontent.com/neoversionsix/custom-ccl-jobs/179e56814dc7083f920dddb63db49b65e1bb5fa3/QUERIES/QUERIES%20FOR%20SPECIFIC%20TOOLS/PHARMACY%20CATALOG%20EXPLORER/Pharmacy%20Order%20Catalog%20Synonym.ccl")
                .then(() => {
                    code1Status.textContent = 'Code copied. Run it, copy the output, and paste it below.';
                    copyCode1Btn.classList.add('disabled');
                    pasteArea1Container.classList.remove('hidden');
                    logMessage("Dataset 1 CCL code copied. Please paste data below.");
                })
                .catch(err => logMessage("ERROR: Failed to copy Dataset 1 code."));
        });
        
        processData1Btn.addEventListener('click', () => {
            const pastedText = pasteArea1.value;
            if(!pastedText) {
                logMessage("ERROR: Paste area for Dataset 1 is empty.");
                data1Status.textContent = 'Please paste data before processing.';
                data1Status.style.color = 'red';
                return;
            }
            const data = parseData(pastedText);
            if (data.length > 0) {
                data1Status.textContent = `Dataset 1 loaded successfully (${data.length} items).`;
                data1Status.style.color = '#28a745';
                appState.datasets[0] = data;
                renderDataTable(data1PreviewContainer, data, { rowCount: 3 });
                logMessage(`Dataset 1 loaded with ${data.length} items.`);
                copyCode2Btn.classList.remove('disabled');
                pasteArea1Container.classList.add('hidden');
            } else {
                data1Status.textContent = 'No data found or failed to parse.';
                data1Status.style.color = 'red';
                logMessage(`ERROR: No data parsed from Dataset 1 input.`);
            }
        });

        copyCode2Btn.addEventListener('click', () => {
            logMessage("Copying Dataset 2 CCL code...");
            copyCode("https://raw.githubusercontent.com/neoversionsix/custom-ccl-jobs/a1d0dc52ec175ae84efa2f59156b3c88bcb66941/QUERIES/QUERIES%20FOR%20SPECIFIC%20TOOLS/PHARMACY%20CATALOG%20EXPLORER/PBS%20mappings.ccl")
                .then(() => {
                    code2Status.textContent = 'Code copied. Run it, copy the output, and paste it below.';
                    copyCode2Btn.classList.add('disabled');
                    pasteArea2Container.classList.remove('hidden');
                    logMessage("Dataset 2 CCL code copied. Please paste data below.");
                })
                .catch(err => logMessage("ERROR: Failed to copy Dataset 2 code."));
        });
        
        processData2Btn.addEventListener('click', () => {
             const pastedText = pasteArea2.value;
             if(!pastedText) {
                logMessage("ERROR: Paste area for Dataset 2 is empty.");
                data2Status.textContent = 'Please paste data before processing.';
                data2Status.style.color = 'red';
                return;
            }
            const data = parseData(pastedText);
            if (data.length > 0) {
                data2Status.textContent = `Dataset 2 loaded successfully (${data.length} items).`;
                data2Status.style.color = '#28a745';
                appState.datasets[1] = data;
                renderDataTable(data2PreviewContainer, data, { rowCount: 3 });
                logMessage(`Dataset 2 loaded with ${data.length} items.`);
                pasteArea2Container.classList.add('hidden');
                initializeSearchView();
            } else {
                data2Status.textContent = 'No data found or failed to parse.';
                data2Status.style.color = 'red';
                logMessage(`ERROR: No data parsed from Dataset 2 input.`);
            }
        });

        searchGoBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        searchColumnSelect.addEventListener('change', () => {
            searchInput.value = '';
            handleSearch();
        });
        clearSearchBtn.addEventListener('click', clearSearch);
        
        document.addEventListener('DOMContentLoaded', resetApp);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracking Board Checkout Fix Tool • CCL Generator</title>
  <style>
    :root{ --bg:#0b0e13; --card:#131823; --muted:#8aa1b2; --text:#e6edf3; --accent:#4fb3ff; --accent-2:#9cd6ff; --good:#2ecc71; --warn:#f1c40f; --bad:#ff6b6b; }
    html,body{height:100%}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1,h2,h3{margin:0 0 10px}
    h1{font-size:20px}
    h2{font-size:15px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:360px minmax(0,1fr);gap:16px;align-items:start}
    .card{background:var(--card);border:1px solid #223046;border-radius:14px;padding:14px;min-width:0}
    .btn{appearance:none;border:1px solid #2a3a4d;background:#17212d;color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;transition:200ms}
    .btn.primary{background:var(--accent);border-color:#3aa2f1;color:#001627;font-weight:700;box-shadow:0 0 0 0 rgba(79,179,255,.7)}
    .btn.primary.attn{animation:pulse 1.2s infinite}
    .btn.inline{margin-left:8px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(79,179,255,.7)}70%{box-shadow:0 0 0 10px rgba(79,179,255,0)}100%{box-shadow:0 0 0 0 rgba(79,179,255,0)}}
    textarea, pre, code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    textarea{width:100%;min-height:120px;border-radius:10px;border:1px solid #2a3a4d;background:#0e1420;color:var(--text);padding:10px;box-sizing:border-box;overflow:auto}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .log{font-size:12px;white-space:pre-wrap;background:#0c1220;border:1px dashed #2a3a4d;border-radius:10px;padding:10px;min-height:76px;max-height:140px;overflow:auto}
    .small{font-size:12px}
    .kbd{border:1px solid #384b63;border-bottom-width:2px;border-radius:6px;padding:1px 6px;background:#0b1622}
    .hidden{display:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a4d}
    .pill.good{border-color:var(--good);color:var(--good)}
    .pill.warn{border-color:var(--warn);color:var(--warn)}
    .pill.bad{border-color:var(--bad);color:var(--bad)}
    .viewport{height:280px;max-width:100%;overflow:auto;border:1px solid #223046;border-radius:10px;background:#0c1220;box-sizing:border-box}
    table{border-collapse:collapse;width:100%;min-width:1100px;font-size:12px;table-layout:auto}
    th,td{border:1px solid #223046;padding:6px 8px}
    th{position:sticky;top:0;background:#0f1626;z-index:1}
    .stepper{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .step{display:flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a3a4d;border-radius:999px}
    .step .n{background:#0f1626;border:1px solid #2a3a4d;border-radius:50%;width:18px;height:18px;display:inline-grid;place-items:center;font-size:11px}
    .step.active{border-color:#3aa2f1;color:var(--accent-2)}
    .banner{margin:8px 0;padding:8px 12px;border:1px solid #223046;border-radius:10px;background:#0c1220;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.show{display:flex}
    .modal .panel{width:min(900px,90vw);background:var(--card);border:1px solid #223046;border-radius:14px;padding:14px;min-width:0}
    .modal textarea{width:100%;height:260px;border-radius:10px;border:1px solid #2a3a4d;background:#0e1420;color:var(--text);padding:10px;box-sizing:border-box}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tracking Board Checkout Fix Tool</h1>
    <h2 class="muted">Generate Cerner CCL <span class="pill">UPDATE</span> scripts to close out stuck tracking rows.</h2>

    <div id="envBanner" class="banner hidden"></div>

    <div class="stepper" id="stepper">
      <div class="step active" id="s1"><span class="n">1</span> Copy extract</div>
      <div class="step" id="s2"><span class="n">2</span> Load data</div>
      <div class="step" id="s3"><span class="n">3</span> Generate</div>
      <div class="step" id="s4"><span class="n">4</span> Copy/Download updates</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>1) Copy the Extract Script</h3>
        <p class="small">Starts with <code>SELECT</code>. Run in Discern. Copy all <strong>tab‑delimited</strong> output including header.</p>
        <div class="row">
          <button id="copyExtract" class="btn primary attn" onclick="window.__copyExtract && window.__copyExtract()">Copy Extract Script</button>
          <button id="downloadExtract" class="btn">Download .ccl</button>
        </div>
        <div class="footer small muted">After running, copy results then proceed to Load Data.</div>
        <hr style="border-color:#223046;border-width:1px 0 0;margin:12px 0">

        <h3>2) Load Output Data</h3>
        <div class="row">
          <button id="loadClipboard" class="btn" disabled>Load from Clipboard</button>
          <button id="pasteManuallyToggle" class="btn" disabled>Paste Manually</button>
          <button id="clearData" class="btn">Clear</button>
        </div>
        <div id="pasteArea" class="hidden" style="margin-top:8px">
          <textarea id="manualPaste" placeholder="Paste the tab-delimited output here, including header row..."></textarea>
          <div class="row"><button id="loadManual" class="btn">Load Pasted Data</button></div>
        </div>
        <hr style="border-color:#223046;border-width:1px 0 0;margin:12px 0">

        <h3>3) Generate Update Script(s)</h3>
        <div class="row">
          <button id="gen" class="btn" disabled>Generate</button>
          <button id="copyUpdates" class="btn" disabled>Copy Updates</button>
          <button id="downloadUpdates" class="btn" disabled>Download .ccl</button>
        </div>
        <p class="small muted">One <span class="pill">UPDATE</span> block per row using <code>__TRACKING_ID__</code>, <code>__DISCH_DT_TM__</code>, <code>__TRACKING_GROUP_CODE__</code>.</p>
        <h3>Console</h3>
        <div id="log" class="log">Ready.</div>
      </div>

      <div class="card">
        <h3>Data Preview</h3>
        <div id="stats" class="small muted">No data loaded.</div>
        <div id="previewViewport" class="viewport"><div id="preview"></div></div>
        <div class="small muted" style="margin-top:6px">Scrollable preview. First 400 rows shown. All rows processed.</div>
        <br>
        <h3>Generated Update Script(s)</h3>
        <textarea id="output" placeholder="Nothing generated yet..." readonly></textarea>
        <br>
        <h3>Update Summary</h3>
        <div id="changesStats" class="small muted">No changes yet.</div>
        <div id="changesViewport" class="viewport"><div id="changes"></div></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Extract Script (exact output of the Copy button)</h3>
      <pre><code id="extractScriptView"></code></pre>
    </div>
  </div>

  <!-- Manual copy modal -->
  <div id="extractModal" class="modal">
    <div class="panel">
      <h3>Manual Copy – Extract Script</h3>
      <p class="small muted">Clipboard writes may be blocked on <code>file://</code>. Select all and copy.</p>
      <textarea id="modalExtract"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="modalSelect" class="btn">Select all</button>
        <button id="modalCopy" class="btn">Copy (fallback)</button>
        <button id="modalClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script id="extractScriptSource" type="text/plain">
SELECT DISTINCT ; Patients stuck on tracking board tables
    __TRACKING_ID__ = TC.TRACKING_ID
    , __DISCH_DT_TM__ = FORMAT(E.DISCH_DT_TM, "DD-MMM-YYYY HH:MM:SS")
    , __TRACKING_GROUP_CODE__ = TC.TRACKING_GROUP_CD
    , NURSE_UNIT = UAR_GET_CODE_DISPLAY(TL.LOC_NURSE_UNIT_CD)
    , ROOM = UAR_GET_CODE_DISPLAY(TL.LOC_ROOM_CD)
    , P.NAME_FULL_FORMATTED
    , PATIENT_URN = PA.ALIAS
    , ENCOUNTER_NO = EA.ALIAS
    , E.ENCNTR_ID
    , ARRIVE_DT_TM = FORMAT(TL.ARRIVE_DT_TM, "DD-MMM-YYYY HH:MM:SS")
    , TL_DEPART_DT_TM = FORMAT(TL.DEPART_DT_TM, "DD-MMM-YYYY HH:MM:SS")
    , TI_DEPART_DT_TM = FORMAT(TI.END_TRACKING_DT_TM, "DD-MMM-YYYY HH:MM:SS")
    , TC_CHECKOUT_DT_TM = FORMAT(TC.CHECKOUT_DT_TM, "DD-MMM-YYYY HH:MM:SS")
    , ENCOUNTER_DISCH = FORMAT(E.DISCH_DT_TM, "DD-MMM-YYYY HH:MM:SS")

FROM
    TRACKING_LOCATOR    TL
  , TRACKING_ITEM       TI
  , TRACKING_CHECKIN    TC
  , PERSON              P
  , ENCOUNTER           E
  , ENCNTR_ALIAS        EA
  , PERSON_ALIAS        PA

PLAN TL ; TRACKING_LOCATOR
    WHERE
        TL.DEPART_DT_TM > CNVTDATETIME(CURDATE,CURTIME) ; Active tracking locators only
        AND TL.LOC_ROOM_CD > 0 ; Must be assigned to a room
        AND TL.ARRIVE_DT_TM < CNVTDATETIME(CURDATE,CURTIME) ; Don't show recent patients (who arrived within last X days)
        ; AND TL.LOC_ROOM_CD = 164237775.00 ;"LEFT VIA SSU/BAU/HUB" CODE SET 220

JOIN TC ; TRACKING_CHECKIN
    WHERE
        TC.TRACKING_ID = TL.TRACKING_ID
        ;AND TC.CHECKOUT_DT_TM > CNVTDATETIME(CURDATE, CURTIME3)

JOIN TI ; TRACKING_ITEM ; Joing to get encounter and person IDs
    WHERE
        TI.TRACKING_ID = TL.TRACKING_ID
        AND TI.CUR_TRACKING_LOCATOR_ID = TL.TRACKING_LOCATOR_ID
        AND TI.TRACKING_TYPE_FLAG = 0
        AND TI.ENCNTR_ID != 0.0
        AND TI.PERSON_ID != 0.0
        AND TI.ACTIVE_IND = 1
        AND TI.END_TRACKING_DT_TM = NULL

JOIN P ; PERSON
    WHERE
        P.PERSON_ID = TI.PERSON_ID
        AND P.ACTIVE_IND = 1
        AND P.BEG_EFFECTIVE_DT_TM <= CNVTDATETIME(CURDATE,CURTIME)
        AND P.END_EFFECTIVE_DT_TM >= CNVTDATETIME(CURDATE,CURTIME)

JOIN E ; ENCOUNTER
    WHERE
        E.ENCNTR_ID = TI.ENCNTR_ID
        AND E.PERSON_ID = TI.PERSON_ID
        AND E.ACTIVE_IND = 1
        AND E.DISCH_DT_TM < CNVTDATETIME(CURDATE,CURTIME)

/* Encounter Identifiers such as the Financial Number */
JOIN EA;ENCNTR_ALIAS; ENCOUNTER_NO = EA.ALIAS ; EA.ENCNTR_ID = O.ENCNTR_ID ; ENCNTR_ALIAS
    WHERE
        EA.ENCNTR_ID = E.ENCNTR_ID
        /* 'FIN/ENCOUNTER/VISIT NBR' from code set 319 */
        AND EA.ENCNTR_ALIAS_TYPE_CD = 1077
        /* active FIN NBRs only */
        AND EA.ACTIVE_IND = 1
        /* effective FIN NBRs only */
        AND EA.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME)

/* For Patient URN */
JOIN PA;PERSON_ALIAS; PATIENT_URN = PA.ALIAS ; PERSON_ALIAS
    WHERE
        PA.PERSON_ID = E.PERSON_ID
        /* this filters for the UR Number Alias' only */
        AND PA.ALIAS_POOL_CD = 9569589.00
        /* Effective Only */
        AND PA.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE, CURTIME3)
        /* Active Only */
        AND PA.ACTIVE_IND = 1

WITH TIME = 30
  </script>

  <script>
  "use strict";
  // Load the extract CCL text
  const extractSource = document.getElementById('extractScriptSource');
  const extractText = extractSource ? extractSource.textContent.replace(/\r?\n/g, '\n').trim() : '';
  window.__EXTRACT_CCL__ = extractText;

  // Global copy helper
  window.__copyExtract = async function(){
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(window.__EXTRACT_CCL__); }
      else{ const ta=document.createElement('textarea'); ta.value=window.__EXTRACT_CCL__; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
      if(window.__afterCopyExtract) window.__afterCopyExtract();
    }catch(e){
      const modal = document.getElementById('extractModal');
      const modalTA = document.getElementById('modalExtract');
      if(modal && modalTA){ modalTA.value = window.__EXTRACT_CCL__; modal.classList.add('show'); modalTA.focus(); modalTA.select(); if(window.__afterCopyExtract) window.__afterCopyExtract(); }
      else{ alert('Copy failed. Press Ctrl+C/Cmd+C to copy from the Extract Script section.'); }
    }
  };

  window.addEventListener('DOMContentLoaded', init);

  function init(){
    const logEl = document.getElementById('log');
    const log = (m)=>{ logEl.textContent += (logEl.textContent?"\n":"") + m; logEl.scrollTop = logEl.scrollHeight };
    const setLog = (m)=>{ logEl.textContent = m };

    const env = document.getElementById('envBanner');
    if(!window.isSecureContext){ env.classList.remove('hidden'); env.innerHTML = 'Running in a non‑secure context (<code>'+location.protocol+'</code>). Clipboard APIs may be blocked. A manual copy fallback will appear.' }

    // Show extract text in the preview block
    document.getElementById('extractScriptView').textContent = window.__EXTRACT_CCL__;

    // Buttons / elements
    const btnCopyExtract = document.getElementById('copyExtract');
    const btnDownloadExtract = document.getElementById('downloadExtract');
    const btnLoadClipboard = document.getElementById('loadClipboard');
    const btnPasteToggle = document.getElementById('pasteManuallyToggle');
    const btnLoadManual = document.getElementById('loadManual');
    const btnClear = document.getElementById('clearData');
    const btnGen = document.getElementById('gen');
    const btnCopyUpdates = document.getElementById('copyUpdates');
    const btnDownloadUpdates = document.getElementById('downloadUpdates');

    const preview = document.getElementById('preview');
    const stats = document.getElementById('stats');
    const output = document.getElementById('output');

    const s1=document.getElementById('s1'), s2=document.getElementById('s2'), s3=document.getElementById('s3'), s4=document.getElementById('s4');
    function setStep(n){ [s1,s2,s3,s4].forEach((el,i)=>{ el.classList.toggle('active', i===n-1) }) }
    function attn(el, on=true){ el.classList.toggle('primary', on); el.classList.toggle('attn', on) }

    let rows = [];

    window.__afterCopyExtract = function(){
      setLog('1/4 Extract ready. Run it in Discern → copy all tab-delimited output (incl. header).');
      btnLoadClipboard.disabled=false; btnPasteToggle.disabled=false;
      attn(btnCopyExtract,false); attn(btnLoadClipboard,true); setStep(2);
    };

    btnCopyExtract.addEventListener('click', ()=> window.__copyExtract());

    // Modal controls
    (function(){
      const modal = document.getElementById('extractModal');
      const modalTA = document.getElementById('modalExtract');
      document.getElementById('modalClose').onclick = ()=> modal.classList.remove('show');
      document.getElementById('modalSelect').onclick = ()=> { modalTA.focus(); modalTA.select(); };
      document.getElementById('modalCopy').onclick = ()=> { try{ document.execCommand('copy'); setLog('1/4 Extract script copied (manual fallback).'); modal.classList.remove('show'); }catch(e){ setLog('Copy failed. Use Ctrl+C / Cmd+C.'); } };
    })();

    btnDownloadExtract.onclick = ()=>{
      const blob = new Blob([window.__EXTRACT_CCL__], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tracking_extract.ccl'; a.click();
    };

    btnPasteToggle.onclick = ()=>{ document.getElementById('pasteArea').classList.toggle('hidden'); };

    btnLoadClipboard.onclick = async()=>{
      try{ const txt = await navigator.clipboard.readText(); loadTSV(txt); }
      catch(e){ log('Clipboard read failed (browser permission). Use "Paste Manually".'); }
    };

    btnLoadManual.onclick = ()=>{ const txt = document.getElementById('manualPaste').value; loadTSV(txt); };

    btnClear.onclick = ()=>{ rows = []; renderPreview(); setLog('Cleared.'); output.value=''; btnGen.disabled=true; btnCopyUpdates.disabled=true; btnDownloadUpdates.disabled=true; attn(btnCopyExtract,true); attn(btnLoadClipboard,false); attn(btnGen,false); setStep(1); };

    function parseTSV(text){ if(!text || !text.trim()) return []; const lines=text.replace(/\r/g,'').split('\n').filter(Boolean); const header=lines[0].split('\t').map(s=>s.trim()); const list=[]; for(let i=1;i<lines.length;i++){ const cols=lines[i].split('\t'); const obj={}; header.forEach((h,idx)=> obj[h]=(cols[idx]??'').trim()); list.push(obj);} return list; }

    function renderPreview(){ if(!rows.length){ stats.textContent='No data loaded.'; preview.innerHTML=''; return } const headers=Object.keys(rows[0]); const tbl=document.createElement('table'); const thead=document.createElement('thead'); const trh=document.createElement('tr'); headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th) }); thead.appendChild(trh); tbl.appendChild(thead); const tb=document.createElement('tbody'); rows.slice(0,400).forEach(r=>{ const tr=document.createElement('tr'); headers.forEach(h=>{ const td=document.createElement('td'); td.textContent=r[h]; tr.appendChild(td) }); tb.appendChild(tr); }); tbl.appendChild(tb); preview.innerHTML=''; preview.appendChild(tbl); stats.innerHTML=`${rows.length} rows loaded.`; }

    function loadTSV(text){ rows=parseTSV(text); if(!rows.length){ setLog('No valid tab-delimited rows detected.'); return } const need=['__TRACKING_ID__','__DISCH_DT_TM__','__TRACKING_GROUP_CODE__']; const missing=need.filter(k=> !(k in rows[0])); if(missing.length){ setLog('Header missing: ' + missing.join(', ')); }
      setLog('2/4 Data loaded. Preview shows first 400 rows (scrollable).'); renderPreview(); btnGen.disabled=false; attn(btnLoadClipboard,false); attn(btnGen,true); setStep(3); }

    function sanitizeDate(d){ // leave as-is, but escape any quotes
      return String(d||'').replaceAll('"','""');
    }

    function generateUpdates(){
      if(!rows.length){ setLog('No data.'); return }

      const TEMPLATE = `; Update Script for Tracking ID: __TRACKING_ID__\nUPDATE INTO TRACKING_CHECKIN TC\n    SET\n          TC.UPDT_CNT = TC.UPDT_CNT + 1\n        , TC.UPDT_ID = REQINFO->UPDT_ID\n        , TC.UPDT_DT_TM = CNVTDATETIME(SYSDATE)\n        , TC.CHECKOUT_DT_TM = CNVTDATETIME("__DISCH_DT_TM__") ; EDIT\n    WHERE\n        TC.TRACKING_ID = __TRACKING_ID__ ; EDIT\n        AND TC.TRACKING_GROUP_CD = __TRACKING_GROUP_CODE__  ; EDIT\n        AND TC.CHECKOUT_DT_TM > CNVTDATETIME(CURDATE, CURTIME3) ;Update only if checkout is in the future\n\nUPDATE INTO TRACKING_ITEM TI\n    SET TI.END_TRACKING_DT_TM = CNVTDATETIME("__DISCH_DT_TM__") ; EDIT\n        , TI.END_TRACKING_ID = 1\n        ; TI.ACTIVE_IND = 0\n        , TI.ACTIVE_STATUS_CD = 192.00\n        , TI.UPDT_DT_TM = CNVTDATETIME(CURDATE, CURTIME3)\n        , TI.UPDT_ID = REQINFO->UPDT_ID\n        , TI.UPDT_TASK = 0\n        , TI.UPDT_APPLCTX = 0.00\n        , TI.UPDT_CNT = TI.UPDT_CNT + 1\n    WHERE\n        TI.TRACKING_ID = __TRACKING_ID__ ; EDIT\n\nUPDATE INTO TRACKING_LOCATOR TL\n    SET TL.DEPART_DT_TM = CNVTDATETIME("__DISCH_DT_TM__") ; EDIT\n        , TL.UPDT_ID = REQINFO->UPDT_ID\n        , TL.UPDT_DT_TM = CNVTDATETIME(SYSDATE)\n        , TL.UPDT_TASK = 0\n        , TL.UPDT_APPLCTX = 0.00\n        , TL.UPDT_CNT = TL.UPDT_CNT + 1\n    WHERE\n        TL.TRACKING_ID = __TRACKING_ID__ ; EDIT\n        AND TL.DEPART_DT_TM > CNVTDATETIME(CURDATE, CURTIME3) ;Update only if checkout is in the future\n;----------------------------------------------------------------`;

      const updates=[]; const changeRows=[]; let made=0, skipped=0;

      for(const r of rows){
        const id = r['__TRACKING_ID__']?.trim();
        const dt = r['__DISCH_DT_TM__']?.trim();
        const grp = r['__TRACKING_GROUP_CODE__']?.trim();
        if(!id || !dt || !grp){ skipped++; changeRows.push({TRACKING_ID:id||'(missing)', DISCH_DT_TM:dt||'(missing)', TRACKING_GROUP:grp||'(missing)', STATUS:'Skipped: missing field(s)'}); continue; }
        const filled = TEMPLATE
          .replaceAll('__TRACKING_ID__', id)
          .replaceAll('__TRACKING_GROUP_CODE__', grp)
          .replaceAll('__DISCH_DT_TM__', sanitizeDate(dt));
        updates.push(filled);
        made++;
        changeRows.push({TRACKING_ID:id, DISCH_DT_TM:dt, TRACKING_GROUP:grp, STATUS:'Generated'});
      }

      output.value = updates.join('\n\n');
      const has = updates.length>0; btnCopyUpdates.disabled=!has; btnDownloadUpdates.disabled=!has;
      const summary = `${rows.length} row(s) processed • ${made} script(s) generated • ${skipped} skipped`;
      setLog('3/4 Generation complete. ' + summary);
      attn(btnGen,false); attn(btnCopyUpdates,has); setStep(4);
      renderChangeTable(changeRows, has);
    }

    function renderChangeTable(rows, has){ const cont=document.getElementById('changes'); const cstats=document.getElementById('changesStats'); cont.innerHTML=''; if(!has){ cstats.textContent='No scripts generated.'; return } cstats.textContent=`${rows.length} row(s) processed.`; const tbl=document.createElement('table'); const thead=document.createElement('thead'); const trh=document.createElement('tr'); ['TRACKING_ID','DISCH_DT_TM','TRACKING_GROUP','Status'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th) }); thead.appendChild(trh); tbl.appendChild(thead); const tb=document.createElement('tbody'); rows.forEach(r=>{ const tr=document.createElement('tr'); [r.TRACKING_ID,r.DISCH_DT_TM,r.TRACKING_GROUP,r.STATUS].forEach(c=>{ const td=document.createElement('td'); td.textContent=String(c); tr.appendChild(td) }); tb.appendChild(tr); }); tbl.appendChild(tb); cont.appendChild(tbl); }

    btnGen.onclick = generateUpdates;

    btnCopyUpdates.onclick = async()=>{ await navigator.clipboard.writeText(output.value||''); log('4/4 Update script(s) copied.'); attn(btnCopyUpdates,false); };
    btnDownloadUpdates.onclick = ()=>{ const blob=new Blob([output.value||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tracking_checkout_updates.ccl'; a.click(); };

    // Initial highlight on Copy
    attn(btnCopyExtract,true);
  }
  </script>
</body>
</html>

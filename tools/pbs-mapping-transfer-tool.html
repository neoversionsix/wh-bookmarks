<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi‑Data Set Tool • Embedded Scripts</title>
  <style>
    :root{ --bg:#0b0e13; --card:#131823; --muted:#8aa1b2; --text:#e6edf3; --accent:#4fb3ff; --accent-2:#9cd6ff; --good:#2ecc71; --warn:#f1c40f; --bad:#ff6b6b; }
    html,body{height:100%}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1,h2,h3{margin:0 0 10px}
    h1{font-size:20px}
    h2{font-size:15px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:360px minmax(0,1fr);gap:16px;align-items:start}
    .card{background:var(--card);border:1px solid #223046;border-radius:14px;padding:14px;min-width:0}
    .btn{appearance:none;border:1px solid #2a3a4d;background:#17212d;color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;transition:200ms}
    .btn.primary{background:var(--accent);border-color:#3aa2f1;color:#001627;font-weight:700;box-shadow:0 0 0 0 rgba(79,179,255,.7)}
    .btn.primary.attn{animation:pulse 1.2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(79,179,255,.7)}70%{box-shadow:0 0 0 10px rgba(79,179,255,0)}100%{box-shadow:0 0 0 0 rgba(79,179,255,0)}}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    textarea, pre, code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    textarea{width:100%;min-height:120px;border-radius:10px;border:1px solid #2a3a4d;background:#0e1420;color:var(--text);padding:10px;box-sizing:border-box;overflow:auto}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .log{font-size:12px;white-space:pre-wrap;background:#0c1220;border:1px dashed #2a3a4d;border-radius:10px;padding:10px;min-height:76px;max-height:140px;overflow:auto}
    .small{font-size:12px}
    .viewport{height:280px;max-width:100%;overflow:auto;border:1px solid #223046;border-radius:10px;background:#0c1220;box-sizing:border-box}
    table{border-collapse:collapse;width:100%;min-width:1100px;font-size:12px;table-layout:auto}
    th,td{border:1px solid #223046;padding:6px 8px}
    th{position:sticky;top:0;background:#0f1626;z-index:1}
    .section{margin:14px 0;padding:10px;border:1px solid #223046;border-radius:10px;background:#0c1220}
    .hidden{display:none}
    .stepper{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .step{display:flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a3a4d;border-radius:999px}
    .step .n{background:#0f1626;border:1px solid #2a3a4d;border-radius:50%;width:18px;height:18px;display:inline-grid;place-items:center;font-size:11px}
    .step.active{border-color:#3aa2f1;color:var(--accent-2)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Multi‑Data Set Tool</h1>
    <h2 class="muted">Embed and view each extract script directly in this file. No GitHub fetch.</h2>

    <div class="stepper" id="stepper">
      <div class="step active" id="s1"><span class="n">1</span> Copy extract</div>
      <div class="step" id="s2"><span class="n">2</span> Load data</div>
      <div class="step" id="s3"><span class="n">3</span> Process</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Workflow</h3>
        <ol class="small muted" style="margin-top:6px">
          <li>Copy the embedded extract script for a data set.</li>
          <li>Run in Discern and copy tab‑delimited output (include header).</li>
          <li>Load data from clipboard or paste manually.</li>
          <li>Process all loaded data.</li>
        </ol>

        <div id="dataSetsContainer"></div>

        <div class="row" style="margin-top:10px">
          <button id="processBtn" class="btn" disabled>Process All Data</button>
          <button id="clearAll" class="btn">Clear All</button>
        </div>
        <div id="log" class="log" style="margin-top:10px">Ready.</div>
      </div>

      <div class="card">
        <h3>Processed Output</h3>
        <div id="processedOutput" class="viewport"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Embedded Scripts</h3>
      <p class="small muted">Exact text copied by each “Copy Script” button. You can edit these in this HTML file.</p>
      <div id="allScripts"></div>
    </div>
  </div>

  <!--
    Embed one <script type="text/plain"> block per data set.
    Replace the placeholder text with your actual CCL extract(s).
    You can add or remove blocks and update dataSetsConfig below to match.
  -->
  <script id="ds1_script" type="text/plain">
SELECT DISTINCT
	  P_O_M.PBS_DRUG_ID ; The PBS Drug the synonym is mapped to
	, SYNONYM_ID = P_O_M.SYNONYM_ID ; The Synonym that the PBS Drug is mapped to
  , CATALOG_PRIMARY = UAR_GET_CODE_DISPLAY(O_C_S.CATALOG_CD)
	, CATALOG_MNEMONIC = O_C_S.MNEMONIC ; The Synonym mnemonic
	, CATALOG_MNEMONIC_TYPE = UAR_GET_CODE_DISPLAY(O_C_S.MNEMONIC_TYPE_CD) ; The Synonym Type
	, PBS_CODE = P_L.PBS_ITEM_CODE ; The PBS Item Code
	, PBS_PRIMARY = P_I.DRUG_NAME ; The PBS Primary Name
	, PBS_BRAND = P_D.BRAND_NAME ; The PBS Brand Name
  , PBS_FORM_STRENGTH = P_D.FORM_STRENGTH ; The PBS Form and Strength

FROM
	PBS_OCS_MAPPING   			P_O_M
	, ORDER_CATALOG_SYNONYM   	O_C_S
	, PBS_LISTING				P_L
	, PBS_ITEM					P_I
	, PBS_DRUG					P_D

PLAN P_O_M
    WHERE
    P_O_M.PBS_DRUG_ID != 11111111.00 ; Not Inactive Rows
    AND P_O_M.END_EFFECTIVE_DT_TM > SYSDATE ; Is a current mapping

JOIN O_C_S    WHERE O_C_S.SYNONYM_ID = P_O_M.SYNONYM_ID

JOIN P_D
    WHERE P_D.PBS_DRUG_ID = P_O_M.PBS_DRUG_ID
    AND P_D.END_EFFECTIVE_DT_TM > SYSDATE	; CURRENT PRODUCTS ONLY

JOIN	P_I
    WHERE	P_I.PBS_ITEM_ID = P_D.PBS_ITEM_ID

JOIN	P_L
    WHERE	P_L.PBS_LISTING_ID = P_I.PBS_LISTING_ID

ORDER BY
	P_O_M.PBS_DRUG_ID DESC

WITH TIME = 20,
	NOCOUNTER,
	SEPARATOR=" ",
	FORMAT
  </script>
  <script id="ds2_script" type="text/plain">
SELECT
  SYNONYM_ID_ = O_C_S.SYNONYM_ID ; The Synonym ID
  , CATALOG_PRIMARY = UAR_GET_CODE_DISPLAY(O_C_S.CATALOG_CD)
  , CATALOG_MNEMONIC = O_C_S.MNEMONIC ; The Synonym mnemonic
  , CATALOG_MNEMONIC_TYPE = UAR_GET_CODE_DISPLAY(O_C_S.MNEMONIC_TYPE_CD) ; The Synonym Type
FROM
    , ORDER_CATALOG_SYNONYM   	O_C_S
WHERE
  O_C_S.ACTIVE_IND = 1
  AND O_C_S.CATALOG_TYPE_CD = 2516 ; PHARMACY
WITH NOCOUNTER, SEPARATOR=" ", FORMAT, time = 20
  </script>
  <script id="ds3_script" type="text/plain">
SELECT DISTINCT
	  P_O_M.PBS_DRUG_ID ; The PBS Drug the synonym is mapped to
	, SYNONYM_ID = P_O_M.SYNONYM_ID ; The Synonym that the PBS Drug is mapped to
  , CATALOG_PRIMARY = UAR_GET_CODE_DISPLAY(O_C_S.CATALOG_CD)
	, CATALOG_MNEMONIC = O_C_S.MNEMONIC ; The Synonym mnemonic
	, CATALOG_MNEMONIC_TYPE = UAR_GET_CODE_DISPLAY(O_C_S.MNEMONIC_TYPE_CD) ; The Synonym Type
	, PBS_CODE = P_L.PBS_ITEM_CODE ; The PBS Item Code
	, PBS_PRIMARY = P_I.DRUG_NAME ; The PBS Primary Name
	, PBS_BRAND = P_D.BRAND_NAME ; The PBS Brand Name
  , PBS_FORM_STRENGTH = P_D.FORM_STRENGTH ; The PBS Form and Strength

FROM
	PBS_OCS_MAPPING   			P_O_M
	, ORDER_CATALOG_SYNONYM   	O_C_S
	, PBS_LISTING				P_L
	, PBS_ITEM					P_I
	, PBS_DRUG					P_D

PLAN P_O_M
    WHERE
    P_O_M.PBS_DRUG_ID != 11111111.00 ; Not Inactive Rows
    AND P_O_M.END_EFFECTIVE_DT_TM > SYSDATE ; Is a current mapping

JOIN O_C_S    WHERE O_C_S.SYNONYM_ID = P_O_M.SYNONYM_ID

JOIN P_D
    WHERE P_D.PBS_DRUG_ID = P_O_M.PBS_DRUG_ID
    AND P_D.END_EFFECTIVE_DT_TM > SYSDATE	; CURRENT PRODUCTS ONLY

JOIN	P_I
    WHERE	P_I.PBS_ITEM_ID = P_D.PBS_ITEM_ID

JOIN	P_L
    WHERE	P_L.PBS_LISTING_ID = P_I.PBS_LISTING_ID

ORDER BY
	P_O_M.PBS_DRUG_ID DESC

WITH TIME = 20,
	NOCOUNTER,
	SEPARATOR=" ",
	FORMAT
  </script>
  
  <script>
  "use strict";

  // Configure your data sets here. Map to the embedded <script type="text/plain"> blocks above.
  const dataSetsConfig = [
    { name: "Data Set 1", scriptId: "ds1_script", data: null },
    { name: "Data Set 2", scriptId: "ds2_script", data: null },
    { name: "Data Set 3", scriptId: "ds3_script", data: null }
  ];

  const container = document.getElementById('dataSetsContainer');
  const processBtn = document.getElementById('processBtn');
  const processedOutput = document.getElementById('processedOutput');
  const logEl = document.getElementById('log');
  const allScripts = document.getElementById('allScripts');

  // Stepper + attention helpers
  const s1=document.getElementById('s1'), s2=document.getElementById('s2'), s3=document.getElementById('s3');
  function setStep(n){ [s1,s2,s3].forEach((el,i)=>{ el && el.classList.toggle('active', i===n-1) }) }
  function attn(el, on=true){ if(!el) return; el.classList.toggle('primary', on); el.classList.toggle('attn', on) }
  let currentDataSet = null;

  const log = (m)=>{ logEl.textContent += (logEl.textContent?"\n":"") + m; logEl.scrollTop = logEl.scrollHeight };
  const setLog = (m)=>{ logEl.textContent = m };

  function getEmbeddedScriptText(id){
    const el = document.getElementById(id);
    return (el ? el.textContent : "").replace(/\r?\n/g, "\n").trim();
  }

  // Basic TSV parser
  function parseData(text){
    if(!text || !text.trim()) return [];
    const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
    if(lines.length<2) return [];
    const headers = lines[0].split('\t').map(s=>s.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split('\t');
      const obj = {};
      headers.forEach((h, idx)=> obj[h] = (cols[idx]??'').trim());
      rows.push(obj);
    }
    return rows;
  }

  function createTable(data){
    if(!data || !data.length) return document.createElement('div');
    const headers = Object.keys(data[0]);
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const thr = document.createElement('tr');
    headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; thr.appendChild(th) });
    thead.appendChild(thr); table.appendChild(thead);
    const tb = document.createElement('tbody');
    data.forEach(row=>{
      const tr = document.createElement('tr');
      headers.forEach(h=>{ const td=document.createElement('td'); td.textContent=row[h]; tr.appendChild(td) });
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    return table;
  }

  function createDataSetSection(ds, index){
    const section = document.createElement('div');
    section.className = 'section';
    section.id = 'section-' + index;

    const title = document.createElement('h3');
    title.textContent = ds.name;
    section.appendChild(title);

    // Buttons
    const row = document.createElement('div'); row.className = 'row';
    const copyBtn = document.createElement('button'); copyBtn.className='btn primary'; copyBtn.textContent='Copy Script';
    const downloadBtn = document.createElement('button'); downloadBtn.className='btn'; downloadBtn.textContent='Download .ccl';
    const loadClipboardBtn = document.createElement('button'); loadClipboardBtn.className='btn'; loadClipboardBtn.textContent='Load from Clipboard';
    const pasteToggleBtn = document.createElement('button'); pasteToggleBtn.className='btn'; pasteToggleBtn.textContent='Paste Manually';
    row.append(copyBtn, downloadBtn, loadClipboardBtn, pasteToggleBtn);
    section.appendChild(row);

    // Keep refs for step highlighting
    ds.__copyBtn = copyBtn; ds.__loadBtn = loadClipboardBtn; ds.__pasteToggle = pasteToggleBtn;

    // Manual paste area
    const pasteArea = document.createElement('div'); pasteArea.className='hidden'; pasteArea.style.marginTop='8px';
    const ta = document.createElement('textarea'); ta.placeholder='Paste the tab‑delimited output here, including header row...';
    const loadManual = document.createElement('button'); loadManual.className='btn'; loadManual.textContent='Load Pasted Data';
    const row2 = document.createElement('div'); row2.className='row'; row2.append(loadManual);
    pasteArea.append(ta, row2); section.appendChild(pasteArea);

    // Status + preview
    const status = document.createElement('div'); status.className='small muted'; status.textContent='No data loaded.'; section.appendChild(status);
    const viewport = document.createElement('div'); viewport.className='viewport'; const preview = document.createElement('div'); preview.id='preview-'+index; viewport.appendChild(preview); section.appendChild(viewport);

    // Wire up
    const scriptText = getEmbeddedScriptText(ds.scriptId);

    copyBtn.onclick = async()=>{
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(scriptText); }
        else{ const tmp=document.createElement('textarea'); tmp.value=scriptText; document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); tmp.remove(); }
        // Visible feedback on the button
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'Copied!';
        copyBtn.disabled = true;
        setTimeout(()=>{ copyBtn.textContent = originalText; copyBtn.disabled = false; }, 1200);
        // Step advance
        currentDataSet = index; attn(copyBtn,false); attn(loadClipboardBtn,true); setStep(2);
        log(ds.name + ': Extract script copied.');
      }catch(e){ log(ds.name + ': Copy failed. Copy from the Embedded Scripts section.'); }
    };

    downloadBtn.onclick = ()=>{
      const blob = new Blob([scriptText], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = ds.name.toLowerCase().replace(/\s+/g,'_') + '.ccl'; a.click();
    };

    pasteToggleBtn.onclick = ()=> pasteArea.classList.toggle('hidden');

    function handleLoad(text){
      const parsed = parseData(text);
      if(!parsed.length){ status.textContent='No valid data found.'; return }
      ds.data = parsed;
      status.textContent = parsed.length + ' row(s) loaded.';
      preview.innerHTML='';
      preview.appendChild(createTable(parsed.slice(0, 400)));
      processBtn.disabled = false;
      // Step advance to processing
      attn(loadClipboardBtn,false); attn(processBtn,true); setStep(3);
      log(ds.name + ': Data loaded.');
    }

    loadClipboardBtn.onclick = async()=>{
      try{ const text = await navigator.clipboard.readText(); handleLoad(text); }
      catch(e){ status.textContent='Clipboard read blocked by browser. Use Paste Manually.'; }
    };

    loadManual.onclick = ()=> handleLoad(ta.value);

    return section;
  }

  // Render all data set sections
  dataSetsConfig.forEach((ds, i)=> container.appendChild(createDataSetSection(ds, i)));

  // Initial highlight: encourage copying a script (first data set)
  if(dataSetsConfig.length){ attn(dataSetsConfig[0].__copyBtn, true); }

  // Show all embedded scripts together for quick inspection
  (function renderAllScripts(){
    dataSetsConfig.forEach((ds, i)=>{
      const box = document.createElement('div'); box.className='section';
      const h = document.createElement('h3'); h.textContent = ds.name; box.appendChild(h);
      const pre = document.createElement('pre'); const code = document.createElement('code'); code.textContent = getEmbeddedScriptText(ds.scriptId); pre.appendChild(code);
      box.appendChild(pre);
      allScripts.appendChild(box);
    });
  })();

  // Process all loaded data: simple echo tables for now
  processBtn.onclick = ()=>{
    processedOutput.innerHTML='';
    let any=false;
    dataSetsConfig.forEach(ds=>{
      if(ds.data && ds.data.length){
        any=true;
        const h=document.createElement('h3'); h.textContent = ds.name + ' • Processed Data'; processedOutput.appendChild(h);
        processedOutput.appendChild(createTable(ds.data));
      }
    });
    if(!any){ processedOutput.innerHTML='<div class="small muted">No data loaded yet.</div>'; }
    log('Processed current data sets.');
    attn(processBtn,false);
  };

  document.getElementById('clearAll').onclick = ()=>{
    dataSetsConfig.forEach(ds=> ds.data=null);
    processedOutput.innerHTML='';
    document.querySelectorAll('[id^="preview-"]').forEach(el=> el.innerHTML='');
    document.querySelectorAll('.section .small.muted').forEach((el,i)=>{ if(i%2===0) el.textContent='No data loaded.'; }); // crude but fine
    processBtn.disabled=true;
    setLog('Cleared.');
    setStep(1);
    dataSetsConfig.forEach(ds=> attn(ds.__loadBtn,false));
    attn(processBtn,false);
    if(dataSetsConfig.length){ attn(dataSetsConfig[0].__copyBtn,true); }
  };
  </script>
</body>
</html>
